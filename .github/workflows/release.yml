name: Release

on:
  push:
    tags: [ 'v*.*.*' ]   # or any trigger you prefer
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Perl
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: 'latest'

      - name: Install build deps
        run: |
          cpanm --installdeps .   # install prerequisites
          cpanm --notest ExtUtils::MakeMaker  # if needed

      - name: Configure
        run: perl Makefile.PL

      - name: Run tests
        run: make test

      - name: Build and create distribution
        run: make dist

      - name: List generated file
        run: ls -l *.tar.gz
        
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: '*.tar.gz'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Publish to CPAN
        run: |
          cpan-upload -u ${{ secrets.CPAN_USERNAME }} -p ${{ secrets.CPAN_PASSWORD }} *.tar.gz
